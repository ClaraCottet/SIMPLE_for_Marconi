%% LyX 2.3.2 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[english]{elsarticle}
\usepackage{tgpagella}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{geometry}
\geometry{verbose,tmargin=3cm,bmargin=3cm,lmargin=3cm,rmargin=3cm}
\usepackage{amsmath}
\usepackage{babel}
\begin{document}
\global\long\def\tht{\vartheta}%
\global\long\def\ph{\varphi}%
\global\long\def\balpha{\boldsymbol{\alpha}}%
\global\long\def\btheta{\boldsymbol{\theta}}%
\global\long\def\bJ{\boldsymbol{J}}%
\global\long\def\bGamma{\boldsymbol{\Gamma}}%
\global\long\def\bOmega{\boldsymbol{\Omega}}%
\global\long\def\d{\text{d}}%
\global\long\def\t#1{\text{#1}}%
\global\long\def\m{\text{m}}%
\global\long\def\v#1{\boldsymbol{#1}}%
\global\long\def\u#1{\underline{#1}}%

\global\long\def\t#1{\mathbf{#1}}%
\global\long\def\bA{\boldsymbol{A}}%
\global\long\def\bB{\boldsymbol{B}}%
\global\long\def\c{\mathrm{c}}%
\global\long\def\difp#1#2{\frac{\partial#1}{\partial#2}}%
\global\long\def\xset{{\bf x}}%
\global\long\def\zset{{\bf z}}%
\global\long\def\qset{{\bf q}}%
\global\long\def\pset{{\bf p}}%
\global\long\def\wset{{\bf w}}%
\global\long\def\rset{{\bf r}}%
\global\long\def\yset{\mathbf{y}}%


\title{Comments on geometric and symplectic integration of guiding-center
motion}

\author{Christopher Albert}

\address{Max-Planck-Institut für Plasmaphysik, Boltzmannstraße 2, 85748 Garching,
Germany\\
<albert@alumni.tugraz.at>}

\date{\today}
\maketitle

\makeatletter 
\def\ps@pprintTitle{ 
 \let\@oddhead\@empty 
 \let\@evenhead\@empty                         \def\@oddfoot{\footnotesize\itshape\hfill\today} \def\@evenfoot{\thepage\hfill}
}
\makeatother

\section{Hamiltonian mechanics in non-canonical coordinates}

This section gives a short overview of Hamiltonian mechanics in non-canonical
coordinates $\zset$. These equations of motion can be equivalently
obtained by Euler-Lagrange equations of the phase-space Lagrangian
written in terms of $\zset$ (as in paper of Littlejohn), or by using
the Jacobian matrix of transformation from the canonical Hamiltonian
formalism (as in book of Balescu). Here we take the latter path. Take
equations of motion in canonical coordinates $\zset_{\mathrm{c}}=(\qset,\pset)=(q^{1},q^{2},\dots q^{N},p_{1},p_{2},\dots p_{N})=(z_{c}^{\,\alpha})_{\alpha=1\dots2N}$,
\begin{align}
\dot{q}^{i} & =\frac{\partial H}{\partial p_{i}},\\
\dot{p}_{j} & =-\frac{\partial H}{\partial q^{j}}.
\end{align}
The notation with $i$ and $j$ up and down, but greek indices $\alpha,\beta$
always up comes from the fact that momentum coordinates describe components
of covectors (index down) in velocity space, but also general phase-space
coordinates (index up). More compactly equations of motion can be
written as
\begin{equation}
\dot{z}_{\mathrm{c}}^{\,\alpha}=J^{\alpha\beta}\frac{\partial H}{\partial z_{\mathrm{c}}^{\,\beta}},
\end{equation}
where 
\begin{equation}
(J^{\alpha\beta})=\left(\begin{array}{cc}
0 & (\delta_{i}^{j})\\
(-\delta_{j}^{i}) & 0
\end{array}\right)
\end{equation}
is an antisymmetric matrix with positive and negative identity matrix
in the upper right and lower left block, respectively. Equivalently,
by inverting $\v J$, or just switching order and a minus sign in
canonical equations of motion,
\begin{align}
-\dot{p}_{j} & =\frac{\partial H}{\partial q^{j}},\\
\dot{q}^{i} & =\frac{\partial H}{\partial p_{i}},
\end{align}
we can write
\begin{equation}
\bar{J}_{\alpha\beta}\dot{z}_{\mathrm{c}}^{\,\alpha}=\frac{\partial H}{\partial z_{\mathrm{c}}^{\,\beta}},
\end{equation}
where
\begin{equation}
(\bar{J}_{\alpha\beta})=\left(\begin{array}{cc}
0 & (-\delta_{i}^{j})\\
(\delta_{j}^{i}) & 0
\end{array}\right).
\end{equation}
Now if we switch to non-canonical coordinates $\zset$ the chain rule
tells us that
\begin{align}
\dot{z}_{\mathrm{c}}^{\,\gamma} & =\frac{\partial z_{\mathrm{c}}^{\,\gamma}}{\partial z^{\alpha}}\dot{z}^{\alpha},\\
\frac{\partial H}{\partial z_{\mathrm{c}}^{\delta}} & =\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}\frac{\partial H}{\partial z^{\beta}}.
\end{align}
Thus we can write equations of motion in terms of non-canonical coordinates
as
\begin{align}
\frac{\partial z_{\mathrm{c}}^{\,\gamma}}{\partial z^{\alpha}}\dot{z}^{\alpha} & =J^{\gamma\delta}\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}\frac{\partial H}{\partial z^{\beta}}.
\end{align}
This can be treated in two ways. If we multiply by a left inverse
of the Jacobian matrix of the coordinate transform we obtain
\begin{align}
\dot{z}^{\alpha} & =\frac{\partial z^{\alpha}}{\partial z_{\mathrm{c}}^{\,\gamma}}J^{\gamma\delta}\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}\frac{\partial H}{\partial z^{\beta}}.
\end{align}
This is of an uncoupled Hamiltonian form
\begin{equation}
\dot{z}^{\alpha}=\Lambda^{\alpha\beta}\frac{\partial H}{\partial z^{\beta}}
\end{equation}
with the antisymmetric \emph{Poisson matrix}
\begin{equation}
\Lambda^{\alpha\beta}\equiv\frac{\partial z^{\gamma}}{\partial z_{\mathrm{c}}^{\,\alpha}}J^{\alpha\beta}\frac{\partial z^{\delta}}{\partial z_{\mathrm{c}}^{\,\beta}}.
\end{equation}
By taking the inverse we obtain (covariant) components of the antisymmetric
\emph{symplectic form}
\begin{equation}
(\omega_{\alpha\beta})=(\Lambda^{\alpha\beta})^{-1}
\end{equation}
and coupled equations of motion
\begin{equation}
\omega_{\alpha\beta}\dot{z}^{\beta}=\frac{\partial H}{\partial z^{\alpha}}.
\end{equation}
In terms of tensor calculus in phase-space, the Poisson matrix $\Lambda^{\alpha\beta}$
represents the Poisson tensor in contravariant form, and $\omega_{\alpha\beta}$
represents the symplectic 2-form. Both are antisymmetric and follow
usual transformation properties. In the special case of canonical
coordinates, $\Lambda^{\alpha\beta}=J^{\alpha\beta}$ and $\omega_{\alpha\beta}=\bar{J}_{\alpha\beta}$
are block diagonal antisymmetric matrices. In the general non-canonical
case, $\Lambda^{\alpha\beta}$ and $\omega_{\alpha\beta}$ depend
on phase-space coordinates $\zset$, but not on time $t$.

Geometric integrators that solve equations of motion exactly are symplectic
per definition (2D: Kasilov/Runov and 3D: Eder/Kasilov). For the construction
of numerical symplectic integrators with non-canonical quadrature,
certain tricks are required (Albert/Kasilov). Another alternative
is to keep the formulation with a (degenerate) phase-space Lagrangian
and use stabilized variational integrators (Kraus).

\section{Geometric 3D integrator}

A detailed description of the integrator can be found in the master's
thesis of Michael Eder {[}1{]} who is the main developer of the mesh-based
geometric orbit integration code.

Equations of {[}1{]} can be re-written using an antisymmetric Poisson
matrix. Namely we have equations of motion (2.9) with
\begin{align}
\frac{\d x^{i}}{\d\tau} & =\varepsilon^{ijk}\left(z^{4}\frac{\partial A_{k}}{\partial x^{j}}+2U\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}+\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}\right),\\
\frac{\d v_{\parallel}}{\d\tau} & =\varepsilon^{ijk}\frac{\partial U}{\partial x^{i}}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{align}
The idea is to use linear interpolation of $A_{k},B_{k}/\omega_{c}$
and $U$ independently to obtain a linear set of equations of motion
in each mesh element. Covariant components $h_{k}=B_{k}/B=e/mc\,B_{k}/\omega_{c}$
of the normalized guiding field can be used to compute of $B_{k}/\omega_{c}$,
and $U=(w-J_{\perp}\omega_{c}-e\Phi)$ is computed from linear interpolations
of $\omega_{c}$ and $\Phi$.

\subsection*{Trying to bring the system to Poisson form}

Now the question is what to move into the Poisson matrix, and what
into the Hamiltonian. Since we use $U$ and $v_{\parallel}$ we have
some freedom to move things around. Namely in the exact system
\begin{align}
H & =\frac{mv_{\parallel}^{\,2}}{2}+J_{\perp}\omega_{c}(\xset)+e\Phi(\xset)\\
 & =\frac{mv_{\parallel}^{\,2}}{2}+w-mU(\xset)\\
 & =w.
\end{align}
Using the middle form we obtain the following gradient of $H$ in
phase-space,
\begin{align}
\frac{\partial H}{\partial x^{i}} & =-m\frac{\partial U}{\partial x^{i}},\\
\frac{\partial H}{\partial v_{\parallel}} & =mv_{\parallel}.
\end{align}
Now we want to get equations of motion
\begin{equation}
\dot{z}^{\alpha}=\Lambda^{\alpha\beta}\frac{\partial H}{\partial z^{\beta}}
\end{equation}
with an antisymmetric $\Lambda^{\alpha\beta}$, where $\zset=(x^{1},x^{2},x^{3},v_{\parallel})$,
and we use Greek indices to go from $1\dots4$ rather than $1\dots3$
for Latin ones. We use
\begin{align}
\dot{z}^{i}=\dot{x}^{i} & =\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(v_{\parallel}\frac{\partial A_{k}}{\partial x^{j}}+2U\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}+\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}\right),\\
\dot{z}^{4}=\dot{v}_{\parallel} & =\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\frac{\partial U}{\partial x^{i}}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{align}
Take
\begin{equation}
H=\frac{mv_{\parallel}^{\,2}}{2}+w-mU(\xset).
\end{equation}
Using
\begin{equation}
\Lambda^{i4}=\frac{\varepsilon^{ijk}}{mB_{\parallel}^{\star}\sqrt{g}}\frac{\partial A_{k}}{\partial x^{j}}
\end{equation}
we obtain the first term
\begin{equation}
\Lambda^{i4}\frac{\partial H}{\partial v_{\parallel}}=\frac{\varepsilon^{ijk}}{B_{\parallel}^{\star}\sqrt{g}}\frac{\partial A_{k}}{\partial x^{j}}v_{\parallel}.
\end{equation}
With
\begin{equation}
\Lambda^{ij}=-\frac{\varepsilon^{ijk}}{mB_{\parallel}^{\star}\sqrt{g}}\frac{B_{k}}{\omega_{c}}
\end{equation}
we obtain the spatial part
\begin{equation}
\Lambda^{ij}\frac{\partial H}{\partial x^{j}}=\frac{\varepsilon^{ijk}}{B_{\parallel}^{\star}\sqrt{g}}\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}.
\end{equation}
We for sure want
\begin{align}
\Lambda^{4i} & =-\frac{1}{mB_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right),\\
\Lambda^{44} & =0.
\end{align}
Now what's missing is the middle term with $2U$. Also, we have no
antisymmetry due to a missing term in $\Lambda^{i4}$. Try
\begin{equation}
\Lambda^{i4}=-\Lambda^{4i}\propto\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{equation}
Then
\begin{align}
\Lambda^{i4}\frac{\partial H}{\partial v_{\parallel}} & \propto\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}v_{\parallel}+v_{\parallel}^{\,2}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{align}
This is nearly what we want, except for the $v_{\parallel}^{\,2}$
instead of the $2U$. What we would need is
\begin{equation}
\Lambda^{i4}\propto\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}+\frac{2U}{v_{\parallel}}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{equation}
This is again in conflict with antisymmetry w.r.t. $\Lambda^{4i}$.
Can we tweak the Hamiltonian instead? The condition
\begin{equation}
\frac{\partial H}{\partial v_{\parallel}}=mv_{\parallel}
\end{equation}
makes sense. Would it be possible to obtain $2U$ via a spatial derivative
such that the annoying part with $v_{\parallel}^{\,2}$ is cancelled
out? This means
\begin{equation}
\Lambda^{ij}\frac{\partial H}{\partial x^{j}}\propto\varepsilon^{ilk}(2U-v_{\parallel}^{\,2})\frac{\partial}{\partial x^{l}}\frac{B_{k}}{\omega_{c}}.
\end{equation}
If we can get this done, or how much error we make otherwise, is an
open task. We can take however a different path, which is shown below
in the conclusion.

\subsection*{Conclusion}

To be exactly symplectic the easiest option right now is to solve
the approximate linear system using $2U$ in Eq. (2.8-2.9) of {[}1{]}
only for the initial guess, and during final iterations, solve rather
the variant with $2U=v_{\parallel}^{\,2}$,
\begin{align}
\dot{z}^{i}=\dot{x}^{i} & =\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(v_{\parallel}\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}^{\,2}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}+\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}\right),\\
\dot{z}^{4}=\dot{v}_{\parallel} & =\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\frac{\partial U}{\partial x^{i}}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{align}
where a quadratic term in $v_{\parallel}$ appears. The other option
to replace $v_{\parallel}$ by $U/(2v_{\parallel})$ in the second
equation could cause trouble when $v_{\parallel}$ vanishes at banana
tips. Then we can write equations of motion as a Poisson system
\begin{equation}
\dot{z}^{\alpha}=\Lambda^{\alpha\beta}\frac{\partial H}{\partial z^{\beta}}
\end{equation}
using a Hamiltonian
\begin{equation}
H=\frac{mv_{\parallel}^{\,2}}{2}+w-mU
\end{equation}
with derivatives
\begin{align}
\frac{\partial H}{\partial x^{i}} & =-m\frac{\partial U}{\partial x^{i}},\\
\frac{\partial H}{\partial v_{\parallel}} & =mv_{\parallel}.
\end{align}
and an antisymmetric Poisson matrix with spatial components
\begin{equation}
\Lambda^{ij}=-\frac{\varepsilon^{ijk}}{mB_{\parallel}^{\star}\sqrt{g}}\frac{B_{k}}{\omega_{c}}
\end{equation}
and mixed spatial-$v_{\parallel}$ components
\begin{equation}
\Lambda^{i4}=-\Lambda^{4i}=\frac{1}{mB_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right),
\end{equation}
where $i,j=1\dots3$ and $\alpha,\beta=1\dots4$. Antisymmetry of
$\Lambda^{\alpha\beta}$ guarantees symplecticity, i.e. conservation
of the symplectic form, and thereby phase-space volume (Liouville's
theorem) and conservation of invariants.
\end{document}
