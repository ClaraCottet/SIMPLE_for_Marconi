%% LyX 2.3.2 created this file.  For more info, see http://www.lyx.org/.
%% Do not edit unless you really know what you are doing.
\documentclass[english]{elsarticle}
\usepackage{tgpagella}
\usepackage[T1]{fontenc}
\usepackage[latin9]{inputenc}
\usepackage{geometry}
\geometry{verbose,tmargin=3cm,bmargin=3cm,lmargin=3cm,rmargin=3cm}
\usepackage{amsmath}
\usepackage{babel}
\begin{document}
\global\long\def\tht{\vartheta}%
\global\long\def\ph{\varphi}%
\global\long\def\balpha{\boldsymbol{\alpha}}%
\global\long\def\btheta{\boldsymbol{\theta}}%
\global\long\def\bJ{\boldsymbol{J}}%
\global\long\def\bGamma{\boldsymbol{\Gamma}}%
\global\long\def\bOmega{\boldsymbol{\Omega}}%
\global\long\def\d{\text{d}}%
\global\long\def\t#1{\text{#1}}%
\global\long\def\m{\text{m}}%
\global\long\def\v#1{\boldsymbol{#1}}%
\global\long\def\u#1{\underline{#1}}%

\global\long\def\t#1{\mathbf{#1}}%
\global\long\def\bA{\boldsymbol{A}}%
\global\long\def\bB{\boldsymbol{B}}%
\global\long\def\c{\mathrm{c}}%
\global\long\def\difp#1#2{\frac{\partial#1}{\partial#2}}%
\global\long\def\xset{{\bf x}}%
\global\long\def\zset{{\bf z}}%
\global\long\def\qset{{\bf q}}%
\global\long\def\pset{{\bf p}}%
\global\long\def\wset{{\bf w}}%
\global\long\def\rset{{\bf r}}%
\global\long\def\yset{\mathbf{y}}%


\title{Comments on geometric and symplectic integration of guiding-center
motion}

\author{Christopher Albert}

\address{Max-Planck-Institut für Plasmaphysik, Boltzmannstraße 2, 85748 Garching,
Germany\\
<albert@alumni.tugraz.at>}

\date{\today}
\maketitle

\makeatletter 
\def\ps@pprintTitle{ 
 \let\@oddhead\@empty 
 \let\@evenhead\@empty                         \def\@oddfoot{\footnotesize\itshape\hfill\today} \def\@evenfoot{\thepage\hfill}
}
\makeatother

\section{Hamiltonian mechanics in non-canonical coordinates}

This section gives a short overview of Hamiltonian mechanics in non-canonical
coordinates $\zset$. These equations of motion can be equivalently
obtained by Euler-Lagrange equations of the phase-space Lagrangian
written in terms of $\zset$ (as in paper of Littlejohn), or by using
the Jacobian matrix of transformation from the canonical Hamiltonian
formalism (as in book of Balescu). Here we take the latter path. Take
equations of motion in canonical coordinates $\zset_{\mathrm{c}}=(\qset,\pset)=(q^{1},q^{2},\dots q^{N},p_{1},p_{2},\dots p_{N})=(z_{c}^{\,\alpha})_{\alpha=1\dots2N}$,
\begin{align}
\dot{q}^{i} & =\frac{\partial H}{\partial p_{i}},\\
\dot{p}_{j} & =-\frac{\partial H}{\partial q^{j}}.
\end{align}
The notation with $i$ and $j$ up and down, but greek indices $\alpha,\beta$
always up comes from the fact that momentum coordinates describe components
of covectors (index down) in velocity space, but also general phase-space
coordinates (index up). More compactly equations of motion can be
written as
\begin{equation}
\dot{z}_{\mathrm{c}}^{\,\alpha}=J^{\alpha\beta}\frac{\partial H}{\partial z_{\mathrm{c}}^{\,\beta}},
\end{equation}
where 
\begin{equation}
(J^{\alpha\beta})=\left(\begin{array}{cc}
0 & (\delta_{i}^{j})\\
(-\delta_{j}^{i}) & 0
\end{array}\right)
\end{equation}
is an antisymmetric matrix with positive and negative identity matrix
in the upper right and lower left block, respectively. Equivalently,
by inverting $\v J$, or just switching order and a minus sign in
canonical equations of motion,
\begin{align}
-\dot{p}_{j} & =\frac{\partial H}{\partial q^{j}},\\
\dot{q}^{i} & =\frac{\partial H}{\partial p_{i}},
\end{align}
we can write
\begin{equation}
\bar{J}_{\alpha\beta}\dot{z}_{\mathrm{c}}^{\,\alpha}=\frac{\partial H}{\partial z_{\mathrm{c}}^{\,\beta}},
\end{equation}
where
\begin{equation}
(\bar{J}_{\alpha\beta})=\left(\begin{array}{cc}
0 & (-\delta_{i}^{j})\\
(\delta_{j}^{i}) & 0
\end{array}\right).
\end{equation}
Now if we switch to non-canonical coordinates $\zset$ the chain rule
tells us that
\begin{align}
\dot{z}_{\mathrm{c}}^{\,\gamma} & =\frac{\partial z_{\mathrm{c}}^{\,\gamma}}{\partial z^{\alpha}}\dot{z}^{\alpha},\\
\frac{\partial H}{\partial z_{\mathrm{c}}^{\delta}} & =\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}\frac{\partial H}{\partial z^{\beta}}.
\end{align}
Thus we can write equations of motion in terms of non-canonical coordinates
as
\begin{align}
\frac{\partial z_{\mathrm{c}}^{\,\gamma}}{\partial z^{\alpha}}\dot{z}^{\alpha} & =J^{\gamma\delta}\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}\frac{\partial H}{\partial z^{\beta}}.
\end{align}
This can be treated in two ways. If we multiply by a left inverse
of the Jacobian matrix of the coordinate transform we obtain
\begin{align}
\dot{z}^{\alpha} & =\frac{\partial z^{\alpha}}{\partial z_{\mathrm{c}}^{\,\gamma}}J^{\gamma\delta}\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}\frac{\partial H}{\partial z^{\beta}}.
\end{align}
This is of an uncoupled Hamiltonian form
\begin{equation}
\dot{z}^{\alpha}=\Lambda^{\alpha\beta}\frac{\partial H}{\partial z^{\beta}}
\end{equation}
with the antisymmetric \emph{Poisson matrix}
\begin{equation}
\Lambda^{\alpha\beta}\equiv\frac{\partial z^{\alpha}}{\partial z_{\mathrm{c}}^{\,\gamma}}J^{\gamma\delta}\frac{\partial z^{\beta}}{\partial z_{\mathrm{c}}^{\,\delta}}.
\end{equation}
By taking the inverse we obtain (covariant) components of the antisymmetric
\emph{symplectic form}
\begin{equation}
(\omega_{\alpha\beta})=(\Lambda^{\alpha\beta})^{-1}
\end{equation}
and coupled equations of motion
\begin{equation}
\omega_{\alpha\beta}\dot{z}^{\beta}=\frac{\partial H}{\partial z^{\alpha}}.
\end{equation}
In terms of tensor calculus in phase-space, the Poisson matrix $\Lambda^{\alpha\beta}$
represents the Poisson tensor in contravariant form, and $\omega_{\alpha\beta}$
represents the symplectic 2-form. Both are antisymmetric and follow
usual transformation properties. In the special case of canonical
coordinates, $\Lambda^{\alpha\beta}=J^{\alpha\beta}$ and $\omega_{\alpha\beta}=\bar{J}_{\alpha\beta}$
are block diagonal antisymmetric matrices. In the general non-canonical
case, $\Lambda^{\alpha\beta}$ and $\omega_{\alpha\beta}$ depend
on phase-space coordinates $\zset$, but not on time $t$.

Geometric integrators that solve equations of motion exactly are symplectic
per definition (2D: Kasilov/Runov and 3D: Eder/Kasilov). For the construction
of numerical symplectic integrators with non-canonical quadrature,
certain tricks are required (Albert/Kasilov). Another alternative
is to keep the formulation with a (degenerate) phase-space Lagrangian
and use stabilized variational integrators (Kraus).

\section{Geometric 3D integrator}

A detailed description of the integrator can be found in the master's
thesis of Michael Eder {[}1{]} who is the main developer of the mesh-based
geometric orbit integration code.

Equations of {[}1{]} can be re-written using an antisymmetric Poisson
matrix. Namely we have equations of motion (2.9) with
\begin{align}
\frac{\d x^{i}}{\d\tau} & =\varepsilon^{ijk}\left(z^{4}\frac{\partial A_{k}}{\partial x^{j}}+2U\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}+\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}\right),\\
\frac{\d v_{\parallel}}{\d\tau} & =\varepsilon^{ijk}\frac{\partial U}{\partial x^{i}}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{align}
The idea is to use linear interpolation of $A_{k},B_{k}/\omega_{c}$
and $U$ independently to obtain a linear set of equations of motion
in each mesh element. Covariant components $h_{k}=B_{k}/B=e/mc\,B_{k}/\omega_{c}$
of the normalized guiding field can be used to compute of $B_{k}/\omega_{c}$,
and $U=(w-J_{\perp}\omega_{c}-e\Phi)$ is computed from linear interpolations
of $\omega_{c}$ and $\Phi$.

\subsection*{Trying to bring the system to Poisson form}

Now the question is what to move into the Poisson matrix, and what
into the Hamiltonian. Since we use $U$ and $v_{\parallel}$ we have
some freedom to move things around. Namely in the exact system
\begin{align}
H & =\frac{mv_{\parallel}^{\,2}}{2}+J_{\perp}\omega_{c}(\xset)+e\Phi(\xset)\\
 & =\frac{mv_{\parallel}^{\,2}}{2}+w-mU(\xset)\\
 & =w.
\end{align}
Using the middle form we obtain the following gradient of $H$ in
phase-space,
\begin{align}
\frac{\partial H}{\partial x^{i}} & =-m\frac{\partial U}{\partial x^{i}},\\
\frac{\partial H}{\partial v_{\parallel}} & =mv_{\parallel}.
\end{align}
Now we want to get equations of motion
\begin{equation}
\dot{z}^{\alpha}=\Lambda^{\alpha\beta}\frac{\partial H}{\partial z^{\beta}}
\end{equation}
with an antisymmetric $\Lambda^{\alpha\beta}$, where $\zset=(x^{1},x^{2},x^{3},v_{\parallel})$,
and we use Greek indices to go from $1\dots4$ rather than $1\dots3$
for Latin ones. Antisymmetry of $\Lambda^{\alpha\beta}$ guarantees
symplecticity, i.e. conservation of the symplectic form, and thereby
phase-space volume (Liouville's theorem) and conservation of invariants.
We want to obtain equations of motion (2.8) as
\begin{align}
\dot{z}^{i}=\dot{x}^{i} & =\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(v_{\parallel}\frac{\partial A_{k}}{\partial x^{j}}+2U\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}+\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}\right),\label{eq:xdot}\\
\dot{z}^{4}=\dot{v}_{\parallel} & =\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\frac{\partial U}{\partial x^{i}}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).\label{eq:vpardot}
\end{align}
For sure we want
\begin{align}
\Lambda^{4i} & =-\frac{1}{mB_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right),\\
\Lambda^{44} & =0.
\end{align}
This way the equation (\ref{eq:vpardot}) in $\dot{v}_{\parallel}$
is fulfilled. Antisymmetry requires that
\begin{equation}
\Lambda^{i4}=-\Lambda^{4i}=+\frac{1}{mB_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}\right).
\end{equation}
If we choose in addition
\begin{equation}
\Lambda^{ij}=-\frac{\varepsilon^{ijk}}{mB_{\parallel}^{\star}\sqrt{g}}\frac{B_{k}}{\omega_{c}}
\end{equation}
we obtain 
\begin{equation}
\dot{x}=\Lambda^{i4}\frac{\partial H}{\partial v_{\parallel}}+\Lambda^{ij}\frac{\partial H}{\partial x^{j}}=\frac{1}{B_{\parallel}^{\star}\sqrt{g}}\varepsilon^{ijk}\left(v_{\parallel}\frac{\partial A_{k}}{\partial x^{j}}+v_{\parallel}^{\ 2}\frac{\partial}{\partial x^{j}}\frac{B_{k}}{\omega_{c}}+\frac{B_{k}}{\omega_{c}}\frac{\partial U}{\partial x^{j}}\right).
\end{equation}
Now this is the correct expression (\ref{eq:xdot}) if $v_{\parallel}^{\,2}=2U$
exactly during the whole procedure. This is true due to definition
(2.6) and the time evolution (2.7) of $v_{\parallel}$ based upon
this equation. Any approximation that does not fulfil (2.6) up to
computer accuracy will violate symplecticity.

\section{Normalisation}

\subsection{Normalization in symplectic integrator module of NEO-ORB}

With thermal velocity 
\begin{equation}
v_{0}=\sqrt{\frac{T}{m}}
\end{equation}
we introduce normalised gyroradius
\begin{equation}
\rho_{0}=\frac{mc}{e}v_{0}.
\end{equation}
and dimensionless quantities
\begin{align}
\bar{v}_{\parallel} & =\frac{v_{\parallel}}{v_{0}}\,,\\
\bar{H} & =\frac{H}{T}\,,\\
\bar{t} & =v_{0}\,t\,,\\
\bar{\Phi} & =\frac{e}{T}\Phi\,,\\
\bar{p} & =\frac{p}{mv_{0}}=\frac{v}{v_{0}}=\bar{v}\\
\bar{\mu} & =\frac{\mu}{T}\,.
\end{align}
Cyclotron frequency is
\[
\omega_{c}=\frac{eB}{mc}=\frac{v_{0}}{\rho_{0}}B.
\]
Then

\begin{align}
\bar{H}(\boldsymbol{R},\bar{v}_{\parallel}) & =\frac{\bar{v}_{\parallel}^{\,2}}{2}+\bar{\mu}B(\boldsymbol{R})+\bar{\Phi}(\boldsymbol{R})\\
\bar{p}_{k} & =\frac{mv_{\parallel}h_{k}+\frac{e}{c}A_{k}}{mv_{0}}=\bar{v}_{\parallel}h_{k}+\rho_{0}^{-1}A_{k}\label{eq:pkbar}
\end{align}
then
\begin{align}
\frac{\d q^{k}}{\d\bar{t}}=\frac{\dot{q}^{k}}{v_{0}} & =\frac{1}{v_{0}}\frac{\partial H}{\partial p_{k}}=\frac{T}{mv_{0}^{\,2}}\frac{\partial\bar{H}}{\partial\bar{p}_{k}}=\frac{\partial\bar{H}}{\partial\bar{p}_{k}},\label{eq:qk-1}\\
\frac{\d\bar{p}^{k}}{\d\bar{t}} & =\frac{\dot{p}^{k}}{mv_{0}^{\,2}}=-\frac{1}{T}\frac{\partial H}{\partial q^{k}}=-\frac{\partial\bar{H}}{\partial q^{k}}.\label{eq:pk-1}
\end{align}
Derivatives:
\begin{align}
\frac{\partial\bar{H}}{\partial r} & =\bar{\mu}\frac{\partial B}{\partial r}+\frac{\partial\bar{\Phi}}{\partial r},\quad\frac{\partial\bar{H}}{\partial\bar{v}_{\parallel}}=\bar{v}_{\parallel}
\end{align}


\subsection{Global normalization in NEO-ORB}

With different thermal velocity 
\begin{equation}
v_{0s}=\sqrt{\frac{2T}{m}}=\sqrt{2}v_{0}
\end{equation}
and normalised gyroradius
\begin{equation}
\rho_{0s}=\frac{mc}{e}v_{0s}=\sqrt{2}\rho_{0}.
\end{equation}
Additional parameter 
\begin{align}
\lambda & =\cos\,\Theta_{p}=\frac{v_{\parallel}}{v}=\frac{v_{\parallel}}{\sqrt{v_{\parallel}^{\,2}+v_{\perp}^{\,2}}}\nonumber \\
 & =\sqrt{\frac{m}{2}}\frac{v_{\parallel}}{\sqrt{mv_{\parallel}^{\,2}/2+\mu B}}=\sqrt{\frac{m}{2}}\frac{v_{\parallel}}{\sqrt{H-e\Phi}}.
\end{align}
where the pitch angle $\Theta_{p}$ measures the angle between particle
velocity $\v v$ and magnetic field $\boldsymbol{B}$. Similarly
\begin{align}
\lambda^{2} & =\frac{mv_{\parallel}/2}{H-e\Phi}=\frac{H-\mu B-e\Phi}{H-e\Phi}
\end{align}
so
\begin{equation}
H=\frac{\mu B}{1-\lambda^{2}}+e\Phi.
\end{equation}
We have (non-relativistic)
\begin{align}
\bar{v}_{\parallel s} & =\frac{v_{\parallel}}{v_{0s}}=\frac{\bar{v}_{\parallel}}{\sqrt{2}}\,,\\
\bar{H}_{s} & =\frac{H}{T}=\bar{H}\,,\\
\bar{t}_{s} & =v_{0s}\,t=\sqrt{2}\bar{t}\,,\\
\bar{\Phi}_{s} & =\frac{e}{T}\Phi=\bar{\Phi}\,,\\
\bar{p}_{s} & =\frac{p}{mv_{0s}}=\frac{v}{v_{0s}}=\bar{v}_{s}=\frac{\bar{p}}{\sqrt{2}}=\frac{\bar{v}}{\sqrt{2}}\\
\bar{\mu}_{s} & =\frac{\bar{p}_{s}^{\,2}(1-\lambda^{2})}{2B}=\frac{p^{\,2}(1-\lambda^{2})}{2m^{2}v_{0}^{\,2}B}\nonumber \\
 & =\frac{p_{\perp}^{\,2}}{4mTB}=\frac{\mu}{2T}=\frac{\bar{\mu}}{2}
\end{align}
Cyclotron frequency is
\begin{equation}
\omega_{c}=\frac{eB}{mc}=\frac{v_{0s}}{\rho_{0s}}B.=\frac{v_{0}}{\rho_{0}}B.
\end{equation}

\end{document}
